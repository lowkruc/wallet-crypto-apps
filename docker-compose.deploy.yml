services:
  api:
    image: ${DOCKER_REGISTRY}-api:${IMAGE_TAG:-latest}
    env_file:
      - ${ENV_FILE:-.env.production}
    environment:
      - NODE_ENV=production
      - API_PORT=${API_PORT:-8080}
      - POSTGRES_HOST=postgres
      - DATABASE_URL=postgresql://${POSTGRES_USER:-wallet}:${POSTGRES_PASSWORD:-wallet}@postgres:${POSTGRES_PORT:-5432}/${POSTGRES_DB:-wallet}?schema=public
    ports:
      - "${API_PORT:-8080}:${API_PORT:-8080}"
    depends_on:
      - postgres
    restart: unless-stopped

  admin-web:
    image: ${DOCKER_REGISTRY}-admin-web:${IMAGE_TAG:-latest}
    env_file:
      - ${ENV_FILE:-.env.production}
    depends_on:
      - api
    ports:
      - "${ADMIN_WEB_PORT:-8081}:4173"
    restart: unless-stopped

  reverse-proxy:
    image: ${DOCKER_REGISTRY}-reverse-proxy:${IMAGE_TAG:-latest}
    env_file:
      - ${ENV_FILE:-.env.production}
    environment:
      - API_UPSTREAM=http://api:${API_PORT:-8080}
      - ADMIN_UPSTREAM=http://admin-web:4173
    depends_on:
      - api
      - admin-web
    ports:
      - "${NGINX_PORT:-80}:80"
    restart: unless-stopped

  postgres:
    image: postgres:16-alpine
    env_file:
      - ${ENV_FILE:-.env.production}
    environment:
      - POSTGRES_DB=${POSTGRES_DB:-wallet}
      - POSTGRES_USER=${POSTGRES_USER:-wallet}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-wallet}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    restart: unless-stopped

volumes:
  postgres_data:
