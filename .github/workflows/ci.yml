name: ci-cd

on:
  push:
    tags:
      - v*

env:
  NODE_VERSION: 20
  IMAGE_PREFIX: ${{ vars.IMAGE_PREFIX || format('ghcr.io/{0}', github.repository) }}

jobs:
  lint-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: pnpm
      - run: pnpm install --frozen-lockfile
      - run: pnpm --filter api prisma:generate
      - run: pnpm lint
      - run: pnpm test

  migrate:
    runs-on: ubuntu-latest
    needs: lint-test
    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_DB: wallet
          POSTGRES_USER: wallet
          POSTGRES_PASSWORD: wallet
        options: >-
          --health-cmd="pg_isready -U wallet -d wallet"
          --health-interval=5s
          --health-timeout=5s
          --health-retries=20
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: pnpm
      - run: pnpm install --frozen-lockfile
      - run: pnpm --filter api prisma:generate
      - run: pnpm migrate

  docker-images:
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    needs:
      - lint-test
      - migrate
    permissions:
      contents: read
      packages: write
    env:
      IMAGE_TAG: ${{ github.ref_name }}
    steps:
      - uses: actions/checkout@v4
      - name: Load production env variables
        env:
          FALLBACK_VITE_API_BASE_URL: ${{ secrets.VITE_API_BASE_URL || vars.VITE_API_BASE_URL || 'https://example.com/api' }}
        run: |
          value=$(grep -E '^VITE_API_BASE_URL=' .env.production | cut -d '=' -f2- || true)
          value=${value:-$FALLBACK_VITE_API_BASE_URL}
          echo "VITE_API_BASE_URL=$value" >> "$GITHUB_ENV"
      - uses: docker/setup-buildx-action@v3
      - uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Build & push API image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: apps/api/Dockerfile
          push: true
          tags: ${{ env.IMAGE_PREFIX }}-api:${{ env.IMAGE_TAG }}
      - name: Build & push Admin image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: apps/admin-web/Dockerfile
          push: true
          tags: ${{ env.IMAGE_PREFIX }}-admin-web:${{ env.IMAGE_TAG }}
          build-args: |
            VITE_API_BASE_URL=${{ env.VITE_API_BASE_URL }}
      - name: Build & push Reverse proxy image
        uses: docker/build-push-action@v6
        with:
          context: infra/nginx
          file: infra/nginx/Dockerfile
          push: true
          tags: ${{ env.IMAGE_PREFIX }}-reverse-proxy:${{ env.IMAGE_TAG }}

  deploy:
    runs-on: ubuntu-latest
    needs: docker-images
    if: startsWith(github.ref, 'refs/tags/v')
    env:
      IMAGE_TAG: ${{ github.ref_name }}
      SSH_DEPLOY_DIR: ${{ vars.SSH_TARGET_DIR || vars.TARGET_DIR || secrets.SSH_TARGET_DIR }}
      SSH_DEPLOY_HOST: ${{ format('{0}@{1}', secrets.SSH_USER, secrets.SSH_HOST) }}
      ENV_FILE: .env.production
      DOCKER_REGISTRY: ${{ vars.IMAGE_PREFIX || format('ghcr.io/{0}', github.repository) }}
    steps:
      - uses: actions/checkout@v4
      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_KEY }}
      - name: Add host to known_hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts
      - name: Deploy via Makefile
        run: make deploy
