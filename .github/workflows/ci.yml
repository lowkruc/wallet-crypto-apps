name: ci-cd

on:
  push:
    tags:
      - v*

env:
  NODE_VERSION: 20
  IMAGE_PREFIX: ${{ vars.IMAGE_PREFIX || format('ghcr.io/{0}', github.repository) }}

jobs:
  lint-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: pnpm
      - run: pnpm install --frozen-lockfile
      - run: pnpm lint
      - run: pnpm test

  migrate:
    runs-on: ubuntu-latest
    needs: lint-test
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: pnpm
      - run: pnpm install --frozen-lockfile
      - run: pnpm migrate

  docker-images:
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    needs:
      - lint-test
      - migrate
    permissions:
      contents: read
      packages: write
    env:
      IMAGE_TAG: ${{ github.ref_name }}
    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-buildx-action@v3
      - uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Build & push API image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: apps/api/Dockerfile
          push: true
          tags: ${{ env.IMAGE_PREFIX }}-api:${{ env.IMAGE_TAG }}
      - name: Build & push Admin image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: apps/admin-web/Dockerfile
          push: true
          tags: ${{ env.IMAGE_PREFIX }}-admin-web:${{ env.IMAGE_TAG }}
          build-args: |
            VITE_API_BASE_URL=${{ secrets.VITE_API_BASE_URL || 'https://example.com/api' }}
      - name: Build & push Reverse proxy image
        uses: docker/build-push-action@v6
        with:
          context: infra/nginx
          file: infra/nginx/Dockerfile
          push: true
          tags: ${{ env.IMAGE_PREFIX }}-reverse-proxy:${{ env.IMAGE_TAG }}

  deploy:
    runs-on: ubuntu-latest
    needs: docker-images
    if: startsWith(github.ref, 'refs/tags/v')
    env:
      IMAGE_TAG: ${{ github.ref_name }}
      SSH_TARGET_DIR: ${{ vars.SSH_TARGET_DIR || secrets.SSH_TARGET_DIR }}
    steps:
      - name: Deploy to VM
        uses: appleboy/ssh-action@v1.2.2
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          envs: IMAGE_TAG,SSH_TARGET_DIR
          script: |
            set -euo pipefail
            cd "$SSH_TARGET_DIR"
            git pull --ff-only origin master
            export IMAGE_TAG="$IMAGE_TAG"
            export ENV_FILE=.env.production
            docker compose -f docker-compose.deploy.yml pull
            docker compose -f docker-compose.deploy.yml up -d
